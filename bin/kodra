#!/usr/bin/env bash
#
# Kodra WSL CLI
# Main command interface
#

KODRA_DIR="${KODRA_DIR:-$HOME/.kodra}"
KODRA_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/kodra"

# Colors
C_RESET='\033[0m'
C_RED='\033[0;31m'
C_GREEN='\033[0;32m'
C_YELLOW='\033[0;33m'
C_BLUE='\033[0;34m'
C_CYAN='\033[0;36m'
C_WHITE='\033[1;37m'
C_GRAY='\033[0;90m'

show_help() {
    echo ""
    echo -e "\033[38;5;208m    ██╗  ██╗ ██████╗ ██████╗ ██████╗  █████╗     ██╗    ██╗███████╗██╗     \033[0m"
    echo -e "\033[38;5;214m    ██║ ██╔╝██╔═══██╗██╔══██╗██╔══██╗██╔══██╗    ██║    ██║██╔════╝██║     \033[0m"
    echo -e "\033[38;5;39m    █████╔╝ ██║   ██║██║  ██║██████╔╝███████║    ██║ █╗ ██║███████╗██║     \033[0m"
    echo -e "\033[38;5;33m    ██╔═██╗ ██║   ██║██║  ██║██╔══██╗██╔══██║    ██║███╗██║╚════██║██║     \033[0m"
    echo -e "\033[38;5;27m    ██║  ██╗╚██████╔╝██████╔╝██║  ██║██║  ██║    ╚███╔███╔╝███████║███████╗\033[0m"
    echo -e "\033[38;5;21m    ╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝     ╚══╝╚══╝ ╚══════╝╚══════╝\033[0m"
    echo ""
    echo -e "${C_CYAN}Kodra WSL${C_RESET} v$(show_version) - Agentic Azure engineering with GitHub CLI & Copilot"
    echo ""
    echo -e "${C_WHITE}Usage:${C_RESET}"
    echo "  kodra <command> [flags]"
    echo ""
    echo -e "${C_WHITE}Commands:${C_RESET}"
    echo "  doctor      Check system health and tool installations"
    echo "  repair      Repair Kodra WSL configuration and tools"
    echo "  update      Update all installed tools"
    echo "  setup       Run first-time setup (GitHub, Azure, Git config)"
    echo "  fetch       Show system information"
    echo "  version     Show Kodra WSL version"
    echo "  help        Show this help message"
    echo ""
    echo -e "${C_WHITE}Flags:${C_RESET}"
    echo "  doctor --fix                  Auto-fix missing tools"
    echo "  repair --all                  Repair everything"
    echo "  repair --shell|--docker|--wsl Repair specific area"
    echo ""
    echo -e "${C_WHITE}Examples:${C_RESET}"
    echo "  kodra doctor        # Verify all tools are working"
    echo "  kodra doctor --fix  # Fix missing tools automatically"
    echo "  kodra repair        # Interactive repair"
    echo "  kodra repair --all  # Repair everything"
    echo "  kodra setup         # Configure GitHub and Azure"
    echo ""
}

show_version() {
    if [ -f "$KODRA_DIR/VERSION" ]; then
        cat "$KODRA_DIR/VERSION"
    else
        echo "0.3.0"
    fi
}

run_doctor() {
    "$KODRA_DIR/bin/kodra-sub/doctor.sh" "$@"
}

run_repair() {
    "$KODRA_DIR/bin/kodra-sub/repair.sh" "$@"
}

run_update() {
    "$KODRA_DIR/bin/kodra-sub/update.sh"
}

run_setup() {
    "$KODRA_DIR/bin/kodra-sub/first-run.sh"
}

run_fetch() {
    if command -v fastfetch &> /dev/null; then
        fastfetch
    elif command -v neofetch &> /dev/null; then
        neofetch
    else
        echo -e "${C_CYAN}System Information${C_RESET}"
        echo ""
        echo -e "  OS: $(lsb_release -d 2>/dev/null | cut -f2 || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
        echo -e "  Kernel: $(uname -r)"
        echo -e "  Shell: $SHELL"
        echo -e "  User: $USER"
        if grep -qEi "(microsoft|wsl)" /proc/version 2>/dev/null; then
            echo -e "  WSL: Yes"
        fi
        echo ""
    fi
}

# Main command router
case "${1:-help}" in
    doctor)
        shift
        run_doctor "$@"
        ;;
    repair|fix)
        shift
        run_repair "$@"
        ;;
    update)
        run_update
        ;;
    setup)
        run_setup
        ;;
    fetch|info)
        run_fetch
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${C_RED}Unknown command:${C_RESET} $1"
        show_help
        exit 1
        ;;
esac
